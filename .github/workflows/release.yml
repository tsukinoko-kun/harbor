name: Release

on:
  push:
    tags:
      - "v*"

env:
  HOMEBREW_TAP: tsukinoko-kun/homebrew-tap

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-amd64
            odin-target: linux_amd64
            binary: harbor
            archive: harbor-linux-amd64.tar.gz
          - os: macos-26
            target: macos-arm64
            odin-target: darwin_arm64
            binary: harbor
            archive: harbor-macos-arm64.tar.gz
          - os: windows-latest
            target: windows-amd64
            odin-target: windows_amd64
            binary: harbor.exe
            archive: harbor-windows-amd64.zip

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.target }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Odin
        uses: laytan/setup-odin@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libx11-dev libxcursor-dev libxrandr-dev libxinerama-dev libxi-dev

      - name: Build
        run: |
          odin build src -out:${{ matrix.binary }} -target:${{ matrix.odin-target }} -o:speed

      - name: Create macOS app bundle
        if: startsWith(matrix.os, 'macos')
        run: |
          # Create iconset directory
          mkdir -p Harbor.iconset

          # Generate PNG icons at required sizes from base PNG (1024x1024)
          for size in 16 32 128 256 512; do
            sips -z $size $size icon.png --out Harbor.iconset/icon_${size}x${size}.png
            sips -z $((size * 2)) $((size * 2)) icon.png --out Harbor.iconset/icon_${size}x${size}@2x.png
          done

          # Generate .icns file
          iconutil -c icns Harbor.iconset -o Harbor.icns

          # Create app bundle structure
          mkdir -p Harbor.app/Contents/MacOS
          mkdir -p Harbor.app/Contents/Resources

          # Copy files into bundle
          cp ${{ matrix.binary }} Harbor.app/Contents/MacOS/
          cp assets/macos/Info.plist Harbor.app/Contents/
          cp Harbor.icns Harbor.app/Contents/Resources/

          # Clean up temporary files
          rm -rf Harbor.iconset Harbor.icns

      - name: Create archive (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          tar -czvf ${{ matrix.archive }} Harbor.app

      - name: Create archive (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          tar -czvf ${{ matrix.archive }} ${{ matrix.binary }}

      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Compress-Archive -Path ${{ matrix.binary }} -DestinationPath ${{ matrix.archive }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: ${{ matrix.archive }}
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    name: Create Release

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} release/ \;

      - name: Generate checksums
        working-directory: release
        run: |
          sha256sum * > checksums-sha256.txt
          cat checksums-sha256.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  homebrew:
    needs: release
    runs-on: ubuntu-latest
    name: Update Homebrew Tap

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Calculate SHA256 checksums
        id: sha
        run: |
          echo "macos_arm64=$(sha256sum artifacts/macos-arm64/harbor-macos-arm64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "linux_amd64=$(sha256sum artifacts/linux-amd64/harbor-linux-amd64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Extract version
        id: version
        run: |
          # Remove 'v' prefix from tag
          echo "number=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Generate Cask
        run: |
          mkdir -p Casks
          cat > Casks/harbor.rb << 'CASK_EOF'
          cask "harbor" do
            version "${{ steps.version.outputs.number }}"

            on_arm do
              sha256 "${{ steps.sha.outputs.macos_arm64 }}"
              url "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/harbor-macos-arm64.tar.gz"
            end

            name "Harbor"
            desc "GUI application for Docker"
            homepage "https://github.com/${{ github.repository }}"

            app "Harbor.app"
          end
          CASK_EOF

      - name: Generate Formula
        run: |
          mkdir -p Formula
          cat > Formula/harbor.rb << 'FORMULA_EOF'
          class Harbor < Formula
            desc "GUI application for Docker"
            homepage "https://github.com/${{ github.repository }}"
            version "${{ steps.version.outputs.number }}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/harbor-macos-arm64.tar.gz"
                sha256 "${{ steps.sha.outputs.macos_arm64 }}"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/harbor-linux-amd64.tar.gz"
                sha256 "${{ steps.sha.outputs.linux_amd64 }}"
              end
            end

            def install
              bin.install "harbor"
            end

            test do
              assert_predicate bin/"harbor", :executable?
            end
          end
          FORMULA_EOF

      - name: Push to Homebrew Tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/${{ env.HOMEBREW_TAP }}.git" tap

          mkdir -p tap/Casks tap/Formula
          cp Casks/harbor.rb tap/Casks/
          cp Formula/harbor.rb tap/Formula/

          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Casks/harbor.rb Formula/harbor.rb

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update harbor to ${{ github.ref_name }}"
            git push
          fi
