name: Release

on:
  push:
    tags:
      - "v*"

env:
  HOMEBREW_TAP: tsukinoko-kun/homebrew-tap

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-amd64
            goos: linux
            goarch: amd64
            binary: harbor
            archive: harbor-linux-amd64.tar.gz
          - os: macos-14
            target: macos-arm64
            goos: darwin
            goarch: arm64
            binary: harbor
            archive: harbor-macos-arm64.tar.gz
          - os: windows-latest
            target: windows-amd64
            goos: windows
            goarch: amd64
            binary: harbor.exe
            archive: harbor-windows-amd64.zip

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.target }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc pkg-config libwayland-dev libx11-dev libx11-xcb-dev libxkbcommon-x11-dev libgles2-mesa-dev libegl1-mesa-dev libffi-dev libxcursor-dev libvulkan-dev

      - name: Build
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          COMMIT="$(git rev-parse HEAD)"
          COMMIT_DATE="$(git log -1 --format=%cI)"
          go build -ldflags="-s -w -X 'github.com/tsukinoko-kun/harbor/internal/version.Version=${VERSION}' -X 'github.com/tsukinoko-kun/harbor/internal/version.Commit=${COMMIT}' -X 'github.com/tsukinoko-kun/harbor/internal/version.CommitDate=${COMMIT_DATE}'" -o ${{ matrix.binary }} .

      - name: Create macOS app bundle
        if: startsWith(matrix.os, 'macos')
        run: |
          # Create iconset directory
          mkdir -p Harbor.iconset

          # Generate PNG icons at required sizes from base PNG (1024x1024)
          for size in 16 32 128 256 512; do
            sips -z $size $size icon.png --out Harbor.iconset/icon_${size}x${size}.png
            sips -z $((size * 2)) $((size * 2)) icon.png --out Harbor.iconset/icon_${size}x${size}@2x.png
          done

          # Generate .icns file
          iconutil -c icns Harbor.iconset -o Harbor.icns

          # Create app bundle structure
          mkdir -p Harbor.app/Contents/MacOS
          mkdir -p Harbor.app/Contents/Resources

          # Copy files into bundle
          cp ${{ matrix.binary }} Harbor.app/Contents/MacOS/

          # Generate Info.plist
          cat > Harbor.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>harbor</string>
            <key>CFBundleIconFile</key>
            <string>Harbor.icns</string>
            <key>CFBundleIdentifier</key>
            <string>dev.frankreyner.harbor</string>
            <key>CFBundleName</key>
            <string>Harbor</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>${GITHUB_REF_NAME#v}</string>
            <key>CFBundleVersion</key>
            <string>${GITHUB_REF_NAME#v}</string>
            <key>LSMinimumSystemVersion</key>
            <string>11.0</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>NSSupportsAutomaticGraphicsSwitching</key>
            <true/>
          </dict>
          </plist>
          EOF

          cp Harbor.icns Harbor.app/Contents/Resources/

          # Clean up temporary files
          rm -rf Harbor.iconset Harbor.icns

      - name: Create archive (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          # App bundle for Cask
          tar -czvf ${{ matrix.archive }} Harbor.app
          # CLI binary for Formula
          tar -czvf harbor-macos-arm64-cli.tar.gz ${{ matrix.binary }}

      - name: Create Linux AppImage
        if: matrix.os == 'ubuntu-latest'
        run: |
          # Download linuxdeploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/applications

          # Copy binary
          cp ${{ matrix.binary }} AppDir/usr/bin/

          # Copy icon
          cp icon.png AppDir/usr/share/icons/hicolor/256x256/apps/harbor.png

          # Create .desktop file
          cat > AppDir/usr/share/applications/harbor.desktop << EOF
          [Desktop Entry]
          Name=Harbor
          Exec=harbor
          Icon=harbor
          Type=Application
          Categories=Development;Utility;
          Comment=GUI application for Docker
          EOF

          # Create AppImage
          ARCH=x86_64 ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage --desktop-file AppDir/usr/share/applications/harbor.desktop --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/harbor.png

          # Rename to consistent name
          mv Harbor-x86_64.AppImage harbor-linux-amd64.AppImage

      - name: Create archive (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          tar -czvf ${{ matrix.archive }} ${{ matrix.binary }}

      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Compress-Archive -Path ${{ matrix.binary }} -DestinationPath ${{ matrix.archive }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: ${{ matrix.archive }}
          retention-days: 1

      - name: Upload CLI artifact (macOS)
        if: startsWith(matrix.os, 'macos')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-cli
          path: harbor-macos-arm64-cli.tar.gz
          retention-days: 1

      - name: Upload AppImage artifact (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-appimage
          path: harbor-linux-amd64.AppImage
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    name: Create Release

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.AppImage" \) -exec mv {} release/ \;

      - name: Generate checksums
        working-directory: release
        run: |
          sha256sum * > checksums-sha256.txt
          cat checksums-sha256.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  homebrew:
    needs: release
    runs-on: ubuntu-latest
    name: Update Homebrew Tap

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Calculate SHA256 checksums
        id: sha
        run: |
          echo "macos_arm64=$(sha256sum artifacts/macos-arm64/harbor-macos-arm64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "macos_arm64_cli=$(sha256sum artifacts/macos-arm64-cli/harbor-macos-arm64-cli.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "linux_amd64=$(sha256sum artifacts/linux-amd64-appimage/harbor-linux-amd64.AppImage | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Extract version
        id: version
        run: |
          # Remove 'v' prefix from tag
          echo "number=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Generate Cask
        run: |
          mkdir -p Casks
          cat > Casks/harbor.rb << 'CASK_EOF'
          cask "harbor" do
            version "${{ steps.version.outputs.number }}"

            on_arm do
              sha256 "${{ steps.sha.outputs.macos_arm64 }}"
              url "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/harbor-macos-arm64.tar.gz"
            end

            name "Harbor"
            desc "GUI application for Docker"
            homepage "https://github.com/${{ github.repository }}"

            app "Harbor.app"
          end
          CASK_EOF

      - name: Generate Formula
        run: |
          cat > harbor.rb << 'FORMULA_EOF'
          class Harbor < Formula
            desc "GUI application for Docker"
            homepage "https://github.com/${{ github.repository }}"
            version "${{ steps.version.outputs.number }}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/harbor-macos-arm64-cli.tar.gz"
                sha256 "${{ steps.sha.outputs.macos_arm64_cli }}"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/harbor-linux-amd64.AppImage"
                sha256 "${{ steps.sha.outputs.linux_amd64 }}"
              end
            end

            def install
              if OS.linux?
                bin.install "harbor-linux-amd64.AppImage" => "harbor"
              else
                bin.install "harbor"
              end
            end

            test do
              assert_predicate bin/"harbor", :executable?
            end
          end
          FORMULA_EOF

      - name: Push to Homebrew Tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/${{ env.HOMEBREW_TAP }}.git" tap

          mkdir -p tap/Casks
          cp Casks/harbor.rb tap/Casks/
          cp harbor.rb tap/

          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Casks/harbor.rb harbor.rb

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update harbor to ${{ github.ref_name }}"
            git push
          fi
